<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerJS Communication</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    .hidden {
      display: none !important;
    }
    .btn {
      width: 150px;
      padding: 20px;
      margin: 10px;
      font-size: 18px;
      cursor: pointer;
      border: 2px solid #000;
      border-radius: 5px;
    }
    #senderUI, #receiverUI {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #senderUI input, #senderUI textarea, #receiverUI textarea {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
      width: 300px;
    }
    #senderUI textarea, #receiverUI textarea {
      height: 100px;
    }
    #qrCode {
      margin: 20px;
    }
    #qrScanner {
      margin: 20px;
      width: 300px;
      height: 300px;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="initialScreen">
    <button class="btn" id="senderButton">Sender</button>
    <button class="btn" id="receiverButton">Receiver</button>
  </div>

  <!-- Sender UI -->
  <div id="senderUI" class="hidden">
    <h2>Sender</h2>
    <div id="qrScanner"></div>
    <label for="peerId">Enter Receiver's PeerJS ID (if QR scan fails):</label>
    <input type="text" id="peerId" placeholder="Receiver's ID">
    <button id="connectButton">Connect</button>
    <textarea id="textArea" placeholder="Enter text"></textarea>
  </div>

  <!-- Receiver UI -->
  <div id="receiverUI" class="hidden">
    <h2>Receiver</h2>
    <p>Share this PeerJS ID with the sender:</p>
    <p id="receiverId"></p>
    <div id="qrCode"></div>
    <textarea id="textAreaReceiver" placeholder="Enter text"></textarea>
  </div>
</div>

<script>
  const senderButton = document.getElementById('senderButton');
  const receiverButton = document.getElementById('receiverButton');
  const initialScreen = document.getElementById('initialScreen');
  const senderUI = document.getElementById('senderUI');
  const receiverUI = document.getElementById('receiverUI');
  const peerIdInput = document.getElementById('peerId');
  const connectButton = document.getElementById('connectButton');
  const textAreaSender = document.getElementById('textArea');
  const textAreaReceiver = document.getElementById('textAreaReceiver');
  const receiverIdDisplay = document.getElementById('receiverId');
  const qrCodeElement = document.getElementById('qrCode');
  const qrScannerElement = document.getElementById('qrScanner');

  let peer, conn;

  // Initialize PeerJS
  function initializePeer() {
    peer = new Peer();

    // Set up peer connection events
    peer.on('open', id => {
      console.log("Peer ID: ", id);
      if (senderUI.classList.contains('hidden') === false) {
        console.log('Sender Peer ID:', id);
      } else if (receiverUI.classList.contains('hidden') === false) {
        receiverIdDisplay.innerText = id; // Display receiver's Peer ID
        new QRCode(qrCodeElement, {
          text: id,
          width: 128,
          height: 128
        });
      }
    });

    // Handle incoming connections
    peer.on('connection', connection => {
      console.log('Connection established with sender');
      conn = connection;
      conn.on('data', data => {
        if (data.text) {
          // Update the shared textarea with received message
          textAreaReceiver.value += '\n' + data.text;
        }
      });
    });
  }

  // Show sender UI
  senderButton.addEventListener('click', () => {
    initialScreen.classList.add('hidden');
    senderUI.classList.remove('hidden');
    initializePeer();

    // Start the QR code scanner
    const html5QrCode = new Html5Qrcode("qrScanner");
    html5QrCode.start(
      { facingMode: "environment" }, 
      {
        fps: 10,    // Frame per second for scanning
        qrbox: 250  // Size of the scanning box
      },
      (decodedText, decodedResult) => {
        // When QR code is scanned, use the decoded peerId
        console.log(`Scanned peer ID: ${decodedText}`);
        peerIdInput.value = decodedText; // Fill in the peerId field
        html5QrCode.stop(); // Stop the QR code scanner
      },
      (errorMessage) => {
        console.log(`QR Code error: ${errorMessage}`);
      }
    );
  });

  // Show receiver UI
  receiverButton.addEventListener('click', () => {
    initialScreen.classList.add('hidden');
    receiverUI.classList.remove('hidden');
    initializePeer();
  });

  // Connect to the receiver from sender
  connectButton.addEventListener('click', () => {
    const receiverId = peerIdInput.value;
    if (receiverId) {
      conn = peer.connect(receiverId);
      conn.on('open', () => {
        console.log('Connection established with receiver');
        textAreaSender.addEventListener('input', () => {
          if (conn.open) {
            conn.send({ text: textAreaSender.value });
          }
        });
      });

      conn.on('data', data => {
        if (data.text) {
          // Update the shared textarea with received message
          textAreaSender.value += data.text;
        }
      });
    }
  });
</script>

</body>
</html>

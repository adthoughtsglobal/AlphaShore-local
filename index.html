<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>P2P File & Text Share</title>
    <script src="qrcode.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        section {
            border: 1px solid #ccc;
            padding: 16px;
            margin: 16px;
            width: 90%;
            max-width: 600px;
        }

        textarea {
            width: 100%;
            height: 150px;
        }
    </style>
</head>

<body>

    <h1>P2P File & Text Share</h1>

    <section id="sender">
      <h2>Sender</h2>
      <button id="startCamera">Start Camera</button>
      <div id="camera" style="width: 300px; height: 300px;"></div>
      <button id="scanQR">Scan Receiver QR</button>
    </section>
    
    <section id="receiver">
      <h2>Receiver</h2>
      <button id="generateQR">Generate QR</button>
      <div id="qrReceiver"></div>
      <textarea id="textArea"></textarea>
    </section>
    
    <script defer>
      let pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });
      let dataChannel;
      let isSender = false;
      let html5QrCode;
      let localOfferGenerated = false;
    
      document.getElementById('textArea').addEventListener('input', () => {
        if (dataChannel && dataChannel.readyState === 'open') {
          dataChannel.send(JSON.stringify({ text: document.getElementById('textArea').value }));
        }
      });
    
      pc.ondatachannel = e => {
        dataChannel = e.channel;
        dataChannel.onmessage = msg => {
          let data = JSON.parse(msg.data);
          if (data.text !== undefined) {
            document.getElementById('textArea').value = data.text;
          }
        };
      };
    
      async function createOffer() {
        let offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        localOfferGenerated = true;
      }
    
      pc.onicecandidate = e => {
        if (e.candidate === null && !localOfferGenerated) return; 
        if (e.candidate === null) {
          console.log("No more ICE candidates. Ready to generate QR.");
          QRCode.toCanvas(document.getElementById('qrReceiver'), JSON.stringify(pc.localDescription))
            .catch(err => console.error("QRCode generation error:", err));
        }
      };
    
      pc.onicegatheringstatechange = () => {
        if (pc.iceGatheringState === 'complete' && !localOfferGenerated) {
          console.log("ICE gathering complete, generating QR...");
          QRCode.toCanvas(document.getElementById('qrReceiver'), JSON.stringify(pc.localDescription))
            .catch(err => console.error("QRCode generation error:", err));
        }
      };
    
      document.getElementById('generateQR').onclick = async () => {
        isSender = false;
        await createOffer();
      };
    
      document.getElementById('scanQR').onclick = () => {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("camera");
        }
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            await html5QrCode.stop();
            let remoteDesc = new RTCSessionDescription(JSON.parse(decodedText));
            await pc.setRemoteDescription(remoteDesc);
            dataChannel = pc.createDataChannel("text");
            dataChannel.onopen = () => {
              dataChannel.send(JSON.stringify({ text: document.getElementById('textArea').value }));
            };
            dataChannel.onmessage = msg => {
              let data = JSON.parse(msg.data);
              if (data.text !== undefined) {
                document.getElementById('textArea').value = data.text;
              }
            };
            let answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
          }
        );
      };
    </script>
    
    </body>
    </html>